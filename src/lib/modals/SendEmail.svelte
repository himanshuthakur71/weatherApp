<script lang="ts">
	import { page } from '$app/state';
	import { createEmailHTML } from '$lib/helpers/createEmailHtml';
	import { fade } from 'svelte/transition';

	let { weather, onClose }: { weather: any; onClose: any } = $props();

	const { user } = $derived(page.data);

	let sending = $state(false);

	const sendHealthReport = async () => {
		sending = true;
		try {
			// Create email html
			const emailHtml = createEmailHTML(weather, user);

			if (emailHtml) {
				const emailRes = await fetch('/api/send-email', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						to: user?.email,
						subject: 'Weather Report',
						text: emailHtml
					})
				});

				const emailResult = await emailRes.json();

				if ((emailResult.message = 'Email sent successfully!')) {
					onClose();
				} else {
					alert(`‚ùå Error: ${emailResult.error}`);
				}
			}
		} finally {
			sending = false;
		}
	};
</script>

<dialog id="my_modal_1" class="modal-open modal">
	<div class="relative modal-box bg-white text-[#333]" transition:fade>
		<button
			onclick={onClose}
			type="button"
			aria-label="close"
			class=" absolute top-[15px] right-[15px] cursor-pointer text-error"
		>
			<svg
				xmlns:xlink="http://www.w3.org/1999/xlink"
				xmlns="http://www.w3.org/2000/svg"
				version="1.1"
				width="20px"
				height="20px"
			>
				<g transform="matrix(1 0 0 1 -644 -848 )">
					<path
						d="M 12.021428571428569 10  L 20 2.0214285714285714  L 17.97857142857143 0  L 10 7.9785714285714295  L 2.0214285714285714 0  L 0 2.0214285714285714  L 7.9785714285714295 10  L 0 17.97857142857143  L 2.0214285714285714 20  L 10 12.021428571428569  L 17.97857142857143 20  L 20 17.97857142857143  L 12.021428571428569 10  Z "
						fill-rule="nonzero"
						fill="currentcolor"
						stroke="none"
						transform="matrix(1 0 0 1 644 848 )"
					/>
				</g>
			</svg>
		</button>
		<figure class="flex h-[40px] w-[40px] items-center justify-center text-secondary">
			<svg
				xmlns:xlink="http://www.w3.org/1999/xlink"
				xmlns="http://www.w3.org/2000/svg"
				version="1.1"
				width="40px"
				height="40px"
			>
				<g transform="matrix(1 0 0 1 -28 -28 )">
					<path
						d="M 39.754464285714285 14.0625  C 39.918154761904766 14.196428571428573  40 14.375  40 14.598214285714285  L 40 36.42857142857143  C 40 37.410714285714285  39.65029761904762 38.251488095238095  38.950892857142854 38.950892857142854  C 38.2514880952381 39.65029761904762  37.41071428571429 40  36.42857142857143 40  L 3.5714285714285716 40  C 2.5892857142857144 40  1.7485119047619049 39.65029761904762  1.0491071428571428 38.950892857142854  C 0.34970238095238093 38.251488095238095  0 37.410714285714285  0 36.42857142857143  L 0 14.598214285714285  C 0 14.375  0.0818452380952381 14.196428571428573  0.24553571428571427 14.0625  C 0.36458333333333337 13.95833333333333  0.6547619047619048 13.701636904761902  1.1160714285714286 13.292410714285715  C 1.5773809523809526 12.883184523809522  1.8861607142857142 12.615327380952376  2.0424107142857144 12.488839285714285  C 2.1986607142857144 12.36235119047619  2.5372023809523814 12.08333333333333  3.0580357142857144 11.651785714285715  C 3.5788690476190474 11.220238095238093  4.099702380952381 10.807291666666664  4.620535714285714 10.412946428571427  C 5.1413690476190474 10.01860119047619  5.855654761904763 9.475446428571427  6.763392857142857 8.783482142857144  C 7.6711309523809526 8.091517857142856  8.738839285714286 7.295386904761902  9.966517857142858 6.395089285714284  C 11.194196428571427 5.494791666666665  12.626488095238098 4.449404761904758  14.263392857142858 3.258928571428572  C 14.33779761904762 3.1994047619047583  14.72842261904762 2.901785714285716  15.435267857142858 2.366071428571428  C 16.1421130952381 1.8303571428571441  16.674107142857142 1.4397321428571441  17.03125 1.194196428571428  C 17.388392857142858 0.9486607142857162  17.864583333333336 0.6882440476190466  18.459821428571427 0.41294642857142794  C 19.055059523809526 0.1376488095238093  19.568452380952383 0  20 0  C 20.43154761904762 0  20.944940476190478 0.1376488095238093  21.540178571428573 0.41294642857142794  C 22.13541666666667 0.6882440476190466  22.619047619047624 0.952380952380949  22.991071428571427 1.2053571428571441  C 23.36309523809524 1.4583333333333304  23.89136904761905 1.8452380952380931  24.575892857142854 2.366071428571428  C 25.26041666666667 2.8869047619047583  25.647321428571427 3.184523809523805  25.736607142857146 3.258928571428572  C 27.373511904761905 4.449404761904758  28.805803571428573 5.494791666666665  30.033482142857146 6.395089285714284  C 31.261160714285715 7.295386904761902  32.32886904761905 8.091517857142856  33.236607142857146 8.783482142857144  C 34.14434523809524 9.475446428571427  34.858630952380956 10.01860119047619  35.379464285714285 10.412946428571427  C 35.90029761904762 10.807291666666664  36.421130952380956 11.220238095238093  36.941964285714285 11.651785714285715  C 37.46279761904762 12.08333333333333  37.801339285714285 12.36235119047619  37.957589285714285 12.488839285714285  C 38.113839285714285 12.615327380952376  38.42261904761905 12.883184523809522  38.88392857142857 13.292410714285715  C 39.3452380952381 13.701636904761902  39.63541666666667 13.95833333333333  39.754464285714285 14.0625  Z M 26.339285714285715 28.470982142857146  C 26.949404761904766 28.002232142857146  27.306547619047624 27.730654761904763  27.410714285714285 27.65625  C 31.324404761904766 24.813988095238095  33.89136904761905 22.938988095238095  35.111607142857146 22.03125  C 35.27529761904762 21.91220238095238  35.36830357142858 21.75967261904762  35.390625 21.57366071428571  C 35.41294642857143 21.38764880952381  35.364583333333336 21.21279761904762  35.245535714285715 21.049107142857146  L 34.39732142857143 19.888392857142854  C 34.27827380952381 19.72470238095238  34.12202380952381 19.631696428571427  33.92857142857143 19.609375  C 33.73511904761905 19.587053571428573  33.55654761904762 19.635416666666664  33.392857142857146 19.754464285714285  C 29.955357142857146 22.269345238095237  27.40327380952381 24.12946428571429  25.736607142857146 25.334821428571427  C 25.66220238095238 25.37946428571429  25.275297619047624 25.669642857142854  24.575892857142854 26.205357142857146  C 23.8764880952381 26.741071428571427  23.34449404761905 27.131696428571427  22.979910714285715 27.377232142857146  C 22.61532738095238 27.622767857142854  22.13541666666667 27.883184523809522  21.540178571428573 28.158482142857146  C 20.944940476190478 28.433779761904763  20.43154761904762 28.571428571428573  20 28.571428571428573  C 19.568452380952383 28.571428571428573  19.055059523809526 28.433779761904763  18.459821428571427 28.158482142857146  C 17.864583333333336 27.883184523809522  17.38467261904762 27.622767857142854  17.020089285714285 27.377232142857146  C 16.655505952380953 27.131696428571427  16.123511904761905 26.741071428571427  15.424107142857142 26.205357142857146  C 14.724702380952383 25.669642857142854  14.33779761904762 25.37946428571429  14.263392857142858 25.334821428571427  C 11.495535714285714 23.34077380952381  8.943452380952383 21.480654761904763  6.607142857142857 19.754464285714285  C 6.443452380952381 19.635416666666664  6.2648809523809526 19.587053571428573  6.071428571428571 19.609375  C 5.877976190476192 19.631696428571427  5.721726190476192 19.72470238095238  5.602678571428571 19.888392857142854  L 4.754464285714286 21.049107142857146  C 4.635416666666667 21.21279761904762  4.587053571428571 21.38764880952381  4.609375 21.57366071428571  C 4.631696428571429 21.75967261904762  4.724702380952381 21.91220238095238  4.888392857142857 22.03125  C 6.1086309523809526 22.938988095238095  8.675595238095239 24.813988095238095  12.589285714285714 27.65625  C 12.738095238095239 27.77529761904762  13.11011904761905 28.05803571428571  13.705357142857142 28.50446428571429  C 14.300595238095239 28.950892857142854  14.78422619047619 29.300595238095237  15.15625 29.553571428571427  C 15.528273809523812 29.80654761904762  16.004464285714285 30.100446428571427  16.584821428571427 30.435267857142854  C 17.165178571428573 30.77008928571429  17.741815476190478 31.019345238095237  18.314732142857142 31.18303571428571  C 18.88764880952381 31.346726190476186  19.449404761904763 31.428571428571427  20 31.428571428571427  C 20.55059523809524 31.428571428571427  21.112351190476197 31.346726190476186  21.685267857142854 31.18303571428571  C 22.258184523809526 31.019345238095237  22.845982142857146 30.762648809523814  23.448660714285715 30.412946428571427  C 24.051339285714285 30.063244047619047  24.53125 29.769345238095237  24.888392857142854 29.53125  C 25.245535714285715 29.293154761904763  25.72916666666667 28.939732142857146  26.339285714285715 28.470982142857146  Z "
						fill-rule="nonzero"
						fill="currentColor"
						stroke="none"
						transform="matrix(1 0 0 1 28 28 )"
					/>
				</g>
			</svg>
		</figure>
		<h4 class="text-2xl font-bold">Email</h4>
		<p class=" mb-[20px] text-2xl">Weather Report</p>

		<div>
			<p class=" text-lg">To</p>

			<p class="border-y border-[#d7d7d7] pt-[6px] pb-[11px] text-lg text-[#7f7f7f]">
				<span class="block">{user?.user_metadata?.first_name} {user?.user_metadata?.last_name}</span
				>
				<span class="block">{user?.email}</span>
			</p>

			<p class=" mt-2 text-lg font-light">Weather Report will be send to above email address.</p>
		</div>

		<div class="mt-[54px] w-full">
			<button onclick="{sendHealthReport}" disabled={sending} type="button" class=" btn btn-wide max-w-[160px] btn-lg btn-secondary">
				{#if sending}
					<svg xmlns="http://www.w3.org/2000/svg" width="38" height="38" viewBox="0 0 24 24"
						><path
							fill="none"
							stroke="currentColor"
							stroke-linecap="round"
							stroke-width="2"
							d="M12 6.99998C9.1747 6.99987 6.99997 9.24998 7 12C7.00003 14.55 9.02119 17 12 17C14.7712 17 17 14.75 17 12"
							><animateTransform
								attributeName="transform"
								attributeType="XML"
								dur="560ms"
								from="0,12,12"
								repeatCount="indefinite"
								to="360,12,12"
								type="rotate"
							/></path
						></svg
					>
				{:else}
					Send Email
				{/if}
			</button>
		</div>
	</div>
</dialog>
